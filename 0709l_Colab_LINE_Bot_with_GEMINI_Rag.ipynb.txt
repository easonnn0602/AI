{
  "cells": [
    {
      "cell_type": "code",
      "execution_count": 1,
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "9Ahw4x5hMkN_",
        "outputId": "df4ea978-f655-4692-e9e9-c2bd1cfdee8f"
      },
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "\u001b[?25l   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m0.0/818.9 kB\u001b[0m \u001b[31m?\u001b[0m eta \u001b[36m-:--:--\u001b[0m\r\u001b[2K   \u001b[91m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[91m╸\u001b[0m \u001b[32m809.0/818.9 kB\u001b[0m \u001b[31m68.2 MB/s\u001b[0m eta \u001b[36m0:00:01\u001b[0m\r\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m818.9/818.9 kB\u001b[0m \u001b[31m18.9 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n",
            "\u001b[?25h\u001b[?25l   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m0.0/165.6 kB\u001b[0m \u001b[31m?\u001b[0m eta \u001b[36m-:--:--\u001b[0m\r\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m165.6/165.6 kB\u001b[0m \u001b[31m6.6 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n",
            "\u001b[?25h"
          ]
        }
      ],
      "source": [
        "!pip install Flask pyngrok line-bot-sdk requests --quiet\n",
        "!pip install google-genai --quiet"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 2,
      "metadata": {
        "id": "9ngnvFgWMlli"
      },
      "outputs": [],
      "source": [
        "from google.colab import userdata\n",
        "\n",
        "ngrok_authtoken = userdata.get('NGROK_AUTHTOKEN')\n",
        "line_channel_access_token = userdata.get('LINE_CHANNEL_ACCESS_TOKEN')\n",
        "line_channel_secret = userdata.get('LINE_CHANNEL_SECRET')\n",
        "gemini_api_key = userdata.get('GEMINI_API_KEY')\n",
        "port = 5051\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 3,
      "metadata": {
        "id": "yQSj-lVgNMm3"
      },
      "outputs": [],
      "source": [
        "import os\n",
        "from pyngrok import ngrok"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 4,
      "metadata": {
        "id": "a3yngmFY5jos"
      },
      "outputs": [],
      "source": [
        "ngrok.kill()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 5,
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "bFF8Q-4QNP2m",
        "outputId": "ffc876ba-f69c-4cd1-d0b4-ef9d307ef712"
      },
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Ngrok URL: https://subcritical-readily-mahalia.ngrok-free.dev\n",
            "✅ LINE Webhook URL 已自動更新為：https://subcritical-readily-mahalia.ngrok-free.dev\n"
          ]
        },
        {
          "output_type": "execute_result",
          "data": {
            "text/plain": [
              "True"
            ]
          },
          "metadata": {},
          "execution_count": 5
        }
      ],
      "source": [
        "import requests\n",
        "\n",
        "ngrok.set_auth_token(ngrok_authtoken)\n",
        "tunnel = ngrok.connect(5051, name=\"linebot_tunnel\")\n",
        "webhook_url = tunnel.public_url\n",
        "\n",
        "print(f\"Ngrok URL: {webhook_url}\")\n",
        "\n",
        "# 自動更新 LINE Webhook URL\n",
        "def update_line_webhook(webhook_url):\n",
        "    \"\"\"使用 LINE Messaging API 更新 Webhook URL\"\"\"\n",
        "    url = \"https://api.line.me/v2/bot/channel/webhook/endpoint\"\n",
        "    headers = {\n",
        "        \"Authorization\": f\"Bearer {line_channel_access_token}\",\n",
        "        \"Content-Type\": \"application/json\"\n",
        "    }\n",
        "    data = {\n",
        "        \"endpoint\": webhook_url\n",
        "    }\n",
        "\n",
        "    response = requests.put(url, headers=headers, json=data)\n",
        "\n",
        "    if response.status_code == 200:\n",
        "        print(f\"✅ LINE Webhook URL 已自動更新為：{webhook_url}\")\n",
        "        return True\n",
        "    else:\n",
        "        print(f\"❌ 更新失敗：{response.status_code} - {response.text}\")\n",
        "        return False\n",
        "\n",
        "# 執行更新\n",
        "update_line_webhook(webhook_url)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 6,
      "metadata": {
        "id": "wJY8NK_RMjEW"
      },
      "outputs": [],
      "source": [
        "from google import genai\n",
        "from google.genai.types import Tool, GenerateContentConfig, GoogleSearch\n",
        "\n",
        "# === 初始化 Google Gemini ===\n",
        "client = genai.Client(api_key=gemini_api_key)\n",
        "\n",
        "google_search_tool = Tool(\n",
        "   google_search=GoogleSearch()\n",
        ")\n",
        "\n",
        "chat = client.chats.create(\n",
        "    model=\"gemini-2.5-flash\",\n",
        "    config=GenerateContentConfig(\n",
        "        system_instruction=\"你是一個中文的AI助手，請用繁體中文回答\",\n",
        "        tools=[google_search_tool],\n",
        "        response_modalities=[\"TEXT\"],\n",
        "    )\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 7,
      "metadata": {
        "id": "5dTdm3n-4mlo"
      },
      "outputs": [],
      "source": [
        "def stateful_query(payload):\n",
        "    response = chat.send_message(message=payload)\n",
        "    return response.text"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "f-oeubJyMjEW",
        "outputId": "284103c5-b834-4b30-cfde-d11e1494374d"
      },
      "outputs": [
        {
          "name": "stdout",
          "output_type": "stream",
          "text": [
            "明新科技大學（Minghsin University of Science and Technology），簡稱明新科大，是一所位於臺灣新竹縣新豐鄉的私立科技大學。該校秉持「堅毅、求新、創造」的校訓，以「深耕在地、放眼國際」為願景，致力於培育具備實務經驗與人文素養的專業人才，並以成為「一流產業大學」為發展目標。\n",
            "\n",
            "**歷史沿革**\n",
            "明新科技大學的創辦可追溯至1966年3月1日，當時以「明新工業專科學校」立案，初期設有機械、土木、工業管理三科，首屆招收300名學生。 隨著時代演進和教育部的核准，學校經歷多次改制：\n",
            "*   1993年，更名為「私立明新工商專科學校」。\n",
            "*   1997年7月，改制為「明新技術學院」，並設有專科部。\n",
            "*   2002年8月，奉教育部核准優先升格為「明新科技大學」。\n",
            "*   2018年12月，更名為「明新學校財團法人明新科技大學」。\n",
            "\n",
            "**學術與特色**\n",
            "明新科技大學現設有六個學院，包括半導體學院、工程學院、管理學院、民生學院、人文與設計學院、共同教育學院。 涵蓋20個學系、2個學位學程（含1個博士學位學程）及11個碩士班，致力於培養「跨域整合、務實創新、全人學習」的專業人才。\n",
            "\n",
            "該校鄰近新竹科學園區與工業區，地理位置優越，因此多年來與產業界建立了緊密的產學合作關係，為區域產業培養了大量優秀人才。 明新科大尤其在半導體和AI領域表現突出，積極建置「半導體封裝測試類產線示範工廠」及「半導體產業設備廠務與檢測人才培育基地」，並設有技職體系中第一座「半導體學院」，更獲准設立「半導體科技博士學位學程」，以培育業界所需的半導體專業人才。 此外，學校也積極發展「智慧機械」、「永續智慧商務」等特色領域，並推廣AI科技應用與英語教學，提升學生的國際移動力與全球學習視野。\n",
            "\n",
            "**辦學績效與榮譽**\n",
            "明新科技大學的畢業生深受企業肯定，在《遠見》雜誌「2022企業最愛公私立技職科大調查」中，明新科大在「工程」和「資訊」兩大領域入榜企業最愛私立科大第二名，且畢業生起薪更是私立科大之冠，甚至優於部分國立科大。 學校也以國際化為亮點，國際學生人數居全國之首，打造了多元的校園環境。 明新科大在2025年《大學辦學績效校長互評卓越獎》中排名亦有顯著提升。\n"
          ]
        }
      ],
      "source": [
        "result = stateful_query(\"簡介明新科技大學\")\n",
        "print(result)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "aZby_1004mlp",
        "outputId": "cecda543-5dd0-44a4-e212-fea495928877"
      },
      "outputs": [
        {
          "name": "stdout",
          "output_type": "stream",
          "text": [
            "明新科技大學的現任校長是呂明峯教授。他於2025年2月1日正式上任，成為明新科技大學的第11任校長。\n",
            "\n",
            "呂明峯校長在半導體教育和產業實務方面擁有豐富經驗，並曾打造全台首座半導體封裝測試類產線，同時也推動成立了半導體學院。 他上任後提出了「四大核心模組」的校務治理策略，旨在將明新科大打造成為「具國際魅力的產業科技大學」。\n"
          ]
        }
      ],
      "source": [
        "result2 = stateful_query(\"校長是誰？\")\n",
        "print(result2)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 8,
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "jdG0_hVBMjEX",
        "outputId": "6e35eb7b-9624-4993-9284-d1addfb01b4d"
      },
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            " * Serving Flask app '__main__'\n",
            " * Debug mode: off\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stderr",
          "text": [
            "INFO:werkzeug:\u001b[31m\u001b[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.\u001b[0m\n",
            " * Running on http://127.0.0.1:5051\n",
            "INFO:werkzeug:\u001b[33mPress CTRL+C to quit\u001b[0m\n",
            "INFO:__main__:Request body: {\"destination\":\"U76cbdc862e10d4bc5006a4f38d10ef71\",\"events\":[{\"type\":\"message\",\"message\":{\"type\":\"file\",\"id\":\"595032708586144024\",\"markAsReadToken\":\"DlOSm6AnmWNz8S5JuUQADTT9_9h4XZERa1Rk6koOmmBoCIu_mHoI4zSSSqnS3g7b5HJJJfRYJAwI-4OkHkQQTUS1tvPyCqPBtVxD-Vaovx0gLKkodp3n8nxMdYRC9XH-Y3ECJn_ygsX3J2tepyYxffLV09tvkFfuz3XOdseocrJqD9WMQAeIFdB90X9xDU_W9OoB6BRJf0OSb76Awq365A\",\"fileName\":\"RAG_reference.pdf\",\"fileSize\":24399,\"contentProvider\":{\"type\":\"line\"}},\"webhookEventId\":\"01KE3HVM1V5TZ1J4DTSEPA8VZK\",\"deliveryContext\":{\"isRedelivery\":false},\"timestamp\":1767498436370,\"source\":{\"type\":\"user\",\"userId\":\"U1dd9c39a8d91da6846f0716244d3eece\"},\"replyToken\":\"b8b66166f68d4fdf9eab02f492b65939\",\"mode\":\"active\"}]}\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "BODY:  {\"destination\":\"U76cbdc862e10d4bc5006a4f38d10ef71\",\"events\":[{\"type\":\"message\",\"message\":{\"type\":\"file\",\"id\":\"595032708586144024\",\"markAsReadToken\":\"DlOSm6AnmWNz8S5JuUQADTT9_9h4XZERa1Rk6koOmmBoCIu_mHoI4zSSSqnS3g7b5HJJJfRYJAwI-4OkHkQQTUS1tvPyCqPBtVxD-Vaovx0gLKkodp3n8nxMdYRC9XH-Y3ECJn_ygsX3J2tepyYxffLV09tvkFfuz3XOdseocrJqD9WMQAeIFdB90X9xDU_W9OoB6BRJf0OSb76Awq365A\",\"fileName\":\"RAG_reference.pdf\",\"fileSize\":24399,\"contentProvider\":{\"type\":\"line\"}},\"webhookEventId\":\"01KE3HVM1V5TZ1J4DTSEPA8VZK\",\"deliveryContext\":{\"isRedelivery\":false},\"timestamp\":1767498436370,\"source\":{\"type\":\"user\",\"userId\":\"U1dd9c39a8d91da6846f0716244d3eece\"},\"replyToken\":\"b8b66166f68d4fdf9eab02f492b65939\",\"mode\":\"active\"}]}\n",
            "檔案已下載：/content/uploaded_files/RAG_reference.pdf\n",
            "檔案已上傳到 Gemini：https://generativelanguage.googleapis.com/v1beta/files/adehfldgi463\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stderr",
          "text": [
            "INFO:werkzeug:127.0.0.1 - - [04/Jan/2026 03:47:20] \"POST / HTTP/1.1\" 200 -\n",
            "INFO:__main__:Request body: {\"destination\":\"U76cbdc862e10d4bc5006a4f38d10ef71\",\"events\":[{\"type\":\"message\",\"message\":{\"type\":\"text\",\"id\":\"595032814450376894\",\"quoteToken\":\"18NorOiZxpQ_tsjGuqQSdDOnS7AUqoTlTgK7YGigAvARKaLDHUSSrxi4pTsOFemDCJ4MCFkCJYnPwT0SUTTPUr7aKqmyFYd9GiJVBXQtDtlgY5boluKZM_qYh5ZzlSbF399d6vrSGgdemu0WiPdyLA\",\"markAsReadToken\":\"yAFOUudLCsyLKvqyzXz_FcFI-hKXAzQq6v_riZFbvbamM5G9aJtLL9xSXXVgJhLQ_Z0QhzlP1-36uwcxSFuZIWgQnY159swPcr35SnHpJu4uBTJZpBtk5e0U-agVRaa5-0BnghNCxZaJisKSR_yyK3H_B0TsX3cootB-uPBKosXCy0pVkYaX1mVPBY-aOpUCPRZHt_cfaE_VlmHSBd7Kyg\",\"text\":\"AI 我的電腦效能如何?\"},\"webhookEventId\":\"01KE3HXHVCZC71D97MW6KYK6Z3\",\"deliveryContext\":{\"isRedelivery\":false},\"timestamp\":1767498499440,\"source\":{\"type\":\"user\",\"userId\":\"U1dd9c39a8d91da6846f0716244d3eece\"},\"replyToken\":\"dc47c374ca8d42bf80aab05d84b66974\",\"mode\":\"active\"}]}\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "BODY:  {\"destination\":\"U76cbdc862e10d4bc5006a4f38d10ef71\",\"events\":[{\"type\":\"message\",\"message\":{\"type\":\"text\",\"id\":\"595032814450376894\",\"quoteToken\":\"18NorOiZxpQ_tsjGuqQSdDOnS7AUqoTlTgK7YGigAvARKaLDHUSSrxi4pTsOFemDCJ4MCFkCJYnPwT0SUTTPUr7aKqmyFYd9GiJVBXQtDtlgY5boluKZM_qYh5ZzlSbF399d6vrSGgdemu0WiPdyLA\",\"markAsReadToken\":\"yAFOUudLCsyLKvqyzXz_FcFI-hKXAzQq6v_riZFbvbamM5G9aJtLL9xSXXVgJhLQ_Z0QhzlP1-36uwcxSFuZIWgQnY159swPcr35SnHpJu4uBTJZpBtk5e0U-agVRaa5-0BnghNCxZaJisKSR_yyK3H_B0TsX3cootB-uPBKosXCy0pVkYaX1mVPBY-aOpUCPRZHt_cfaE_VlmHSBd7Kyg\",\"text\":\"AI 我的電腦效能如何?\"},\"webhookEventId\":\"01KE3HXHVCZC71D97MW6KYK6Z3\",\"deliveryContext\":{\"isRedelivery\":false},\"timestamp\":1767498499440,\"source\":{\"type\":\"user\",\"userId\":\"U1dd9c39a8d91da6846f0716244d3eece\"},\"replyToken\":\"dc47c374ca8d42bf80aab05d84b66974\",\"mode\":\"active\"}]}\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stderr",
          "text": [
            "INFO:werkzeug:127.0.0.1 - - [04/Jan/2026 03:48:38] \"POST / HTTP/1.1\" 200 -\n",
            "INFO:__main__:Request body: {\"destination\":\"U76cbdc862e10d4bc5006a4f38d10ef71\",\"events\":[{\"type\":\"message\",\"message\":{\"type\":\"text\",\"id\":\"595033044415938561\",\"quoteToken\":\"abIW46cMidFxms89zyqGj8z44N7d_OgmBswIVGOVt391AzbSIbTwXJvQuG9L5TD1TxO7GfRBcr8HnQ0GFwHLzM8m3bavioIcuU6mIYvjKIsWWF9Ck68_JU_f1N3Nj_5zcXHU8kqkTzClDPV8fuAzMQ\",\"markAsReadToken\":\"geQ2Z-PN7SxzK-p7hLPkieW2N1GHYj9QXOZnw2IzXPwdGNl0FztLZvUmAycEjHFyVZlAo76ht2HB7NssNB_b_csyp-liKYjIcUmcOJf7RNM558zd3ZWzC054oxocD9Wr-qnN25ly2zYZ-xK3gWIBXftMp0_rgkmrARhoYg9CFcyRNaA23g_TSTxO-r7-tMFWATBWgCkp9qOGzDVV7RhePg\",\"text\":\"AI 我用什麼電腦螢幕\"},\"webhookEventId\":\"01KE3J1Q63E8JT6QYXBZT6SB57\",\"deliveryContext\":{\"isRedelivery\":false},\"timestamp\":1767498636424,\"source\":{\"type\":\"user\",\"userId\":\"U1dd9c39a8d91da6846f0716244d3eece\"},\"replyToken\":\"88238388b6ca4bc6a8ed135cb7928c4a\",\"mode\":\"active\"}]}\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "BODY:  {\"destination\":\"U76cbdc862e10d4bc5006a4f38d10ef71\",\"events\":[{\"type\":\"message\",\"message\":{\"type\":\"text\",\"id\":\"595033044415938561\",\"quoteToken\":\"abIW46cMidFxms89zyqGj8z44N7d_OgmBswIVGOVt391AzbSIbTwXJvQuG9L5TD1TxO7GfRBcr8HnQ0GFwHLzM8m3bavioIcuU6mIYvjKIsWWF9Ck68_JU_f1N3Nj_5zcXHU8kqkTzClDPV8fuAzMQ\",\"markAsReadToken\":\"geQ2Z-PN7SxzK-p7hLPkieW2N1GHYj9QXOZnw2IzXPwdGNl0FztLZvUmAycEjHFyVZlAo76ht2HB7NssNB_b_csyp-liKYjIcUmcOJf7RNM558zd3ZWzC054oxocD9Wr-qnN25ly2zYZ-xK3gWIBXftMp0_rgkmrARhoYg9CFcyRNaA23g_TSTxO-r7-tMFWATBWgCkp9qOGzDVV7RhePg\",\"text\":\"AI 我用什麼電腦螢幕\"},\"webhookEventId\":\"01KE3J1Q63E8JT6QYXBZT6SB57\",\"deliveryContext\":{\"isRedelivery\":false},\"timestamp\":1767498636424,\"source\":{\"type\":\"user\",\"userId\":\"U1dd9c39a8d91da6846f0716244d3eece\"},\"replyToken\":\"88238388b6ca4bc6a8ed135cb7928c4a\",\"mode\":\"active\"}]}\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stderr",
          "text": [
            "INFO:werkzeug:127.0.0.1 - - [04/Jan/2026 03:50:40] \"POST / HTTP/1.1\" 200 -\n",
            "INFO:__main__:Request body: {\"destination\":\"U76cbdc862e10d4bc5006a4f38d10ef71\",\"events\":[{\"type\":\"message\",\"message\":{\"type\":\"text\",\"id\":\"595033093204345429\",\"quoteToken\":\"uZogsLSZKrDZzBcaJ-YyfxVhddSauQZ_7iRtQQ0eDWqXA5Ah2ylGBtQy9X7PbM32Ga5WNmylpsFKLwrujLPGbU9Q7Uukx4HJVUF2ln7MTQ7wE-wkYg0yTWxLrGGX-7vva_PSaFa8XdLgCMLzyfosHg\",\"markAsReadToken\":\"f7BsUlIfGKngTXUVGd3fgVtHlj_eufLKHOtt891E1BNpz6P1o2-TylHvMqoKVm9BTsVKdZHGsJb-35iBgvb3wrljGAxh1hW9nz38zTGumakMt78yrgKs4JKWQO8WCzcgZNwdndOaDLAeWfl--AIeIoaFG1ljQVoFxd294pDH32oLCu9OySAC1PJ8J2gyZyZEtTiMdFBwINSZQzC3fUTU6g\",\"text\":\"AI 我的CPU效能很好嗎\"},\"webhookEventId\":\"01KE3J2M752TV3BJ766EP8755S\",\"deliveryContext\":{\"isRedelivery\":false},\"timestamp\":1767498665704,\"source\":{\"type\":\"user\",\"userId\":\"U1dd9c39a8d91da6846f0716244d3eece\"},\"replyToken\":\"fa361d670e0a44e39e58e71413406494\",\"mode\":\"active\"}]}\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "BODY:  {\"destination\":\"U76cbdc862e10d4bc5006a4f38d10ef71\",\"events\":[{\"type\":\"message\",\"message\":{\"type\":\"text\",\"id\":\"595033093204345429\",\"quoteToken\":\"uZogsLSZKrDZzBcaJ-YyfxVhddSauQZ_7iRtQQ0eDWqXA5Ah2ylGBtQy9X7PbM32Ga5WNmylpsFKLwrujLPGbU9Q7Uukx4HJVUF2ln7MTQ7wE-wkYg0yTWxLrGGX-7vva_PSaFa8XdLgCMLzyfosHg\",\"markAsReadToken\":\"f7BsUlIfGKngTXUVGd3fgVtHlj_eufLKHOtt891E1BNpz6P1o2-TylHvMqoKVm9BTsVKdZHGsJb-35iBgvb3wrljGAxh1hW9nz38zTGumakMt78yrgKs4JKWQO8WCzcgZNwdndOaDLAeWfl--AIeIoaFG1ljQVoFxd294pDH32oLCu9OySAC1PJ8J2gyZyZEtTiMdFBwINSZQzC3fUTU6g\",\"text\":\"AI 我的CPU效能很好嗎\"},\"webhookEventId\":\"01KE3J2M752TV3BJ766EP8755S\",\"deliveryContext\":{\"isRedelivery\":false},\"timestamp\":1767498665704,\"source\":{\"type\":\"user\",\"userId\":\"U1dd9c39a8d91da6846f0716244d3eece\"},\"replyToken\":\"fa361d670e0a44e39e58e71413406494\",\"mode\":\"active\"}]}\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stderr",
          "text": [
            "INFO:werkzeug:127.0.0.1 - - [04/Jan/2026 03:51:17] \"POST / HTTP/1.1\" 200 -\n",
            "WARNING:pyngrok.process.ngrok:t=2026-01-04T03:51:40+0000 lvl=warn msg=\"Stopping forwarder\" name=linebot_tunnel acceptErr=\"failed to accept connection: Listener closed\"\n"
          ]
        }
      ],
      "source": [
        "from flask import Flask, request, abort\n",
        "import logging\n",
        "import os\n",
        "import time\n",
        "from google.genai import types\n",
        "\n",
        "from linebot.v3 import (\n",
        "    WebhookHandler\n",
        ")\n",
        "from linebot.v3.exceptions import (\n",
        "    InvalidSignatureError\n",
        ")\n",
        "from linebot.v3.messaging import (\n",
        "    Configuration,\n",
        "    ApiClient,\n",
        "    MessagingApi,\n",
        "    MessagingApiBlob,\n",
        "    ReplyMessageRequest,\n",
        "    TextMessage\n",
        ")\n",
        "from linebot.v3.webhooks import (\n",
        "    MessageEvent,\n",
        "    TextMessageContent,\n",
        "    FileMessageContent\n",
        ")\n",
        "\n",
        "app = Flask(__name__)\n",
        "\n",
        "logging.basicConfig(\n",
        "    level=logging.INFO, format=\"%(asctime)s - %(levelname)s - %(message)s\"\n",
        ")\n",
        "app.logger.setLevel(logging.INFO)\n",
        "\n",
        "configuration = Configuration(access_token=line_channel_access_token)\n",
        "handler = WebhookHandler(line_channel_secret)\n",
        "\n",
        "# 儲存檔案的目錄\n",
        "UPLOAD_DIR = \"/content/uploaded_files\"\n",
        "os.makedirs(UPLOAD_DIR, exist_ok=True)\n",
        "\n",
        "# 儲存每個使用者的對話 session 和上傳的檔案\n",
        "user_sessions = {}  # {user_id: {\"chat\": chat_object, \"uploaded_file\": gemini_file}}\n",
        "\n",
        "def get_user_session(user_id):\n",
        "    \"\"\"取得或建立使用者的對話 session\"\"\"\n",
        "    if user_id not in user_sessions:\n",
        "        # 建立新的對話 session\n",
        "        new_chat = client.chats.create(\n",
        "            model=\"gemini-2.5-flash\",\n",
        "            config=GenerateContentConfig(\n",
        "                system_instruction=\"你是一個中文的AI助手，請用繁體中文回答。如果使用者有提供參考文件，請根據文件內容回答問題。\",\n",
        "                tools=[google_search_tool],\n",
        "                response_modalities=[\"TEXT\"],\n",
        "            )\n",
        "        )\n",
        "        user_sessions[user_id] = {\n",
        "            \"chat\": new_chat,\n",
        "            \"uploaded_file\": None\n",
        "        }\n",
        "    return user_sessions[user_id]\n",
        "\n",
        "def download_line_file(message_id, file_name):\n",
        "    \"\"\"從 LINE 下載使用者上傳的檔案\"\"\"\n",
        "    with ApiClient(configuration) as api_client:\n",
        "        line_bot_blob_api = MessagingApiBlob(api_client)\n",
        "        file_content = line_bot_blob_api.get_message_content(message_id)\n",
        "\n",
        "        file_path = os.path.join(UPLOAD_DIR, file_name)\n",
        "\n",
        "        with open(file_path, 'wb') as f:\n",
        "            f.write(file_content)\n",
        "\n",
        "        return file_path\n",
        "\n",
        "def upload_file_to_gemini(file_path):\n",
        "    \"\"\"上傳檔案到 Gemini Files API\"\"\"\n",
        "    uploaded_file = client.files.upload(\n",
        "        file=file_path,\n",
        "        config={'display_name': os.path.basename(file_path)}\n",
        "    )\n",
        "\n",
        "    # 等待檔案處理完成\n",
        "    while uploaded_file.state.name == \"PROCESSING\":\n",
        "        print(\"檔案處理中...\")\n",
        "        time.sleep(1)\n",
        "        uploaded_file = client.files.get(name=uploaded_file.name)\n",
        "\n",
        "    if uploaded_file.state.name == \"FAILED\":\n",
        "        raise Exception(\"檔案上傳處理失敗\")\n",
        "\n",
        "    return uploaded_file\n",
        "\n",
        "def query_with_rag(user_id, question):\n",
        "    \"\"\"使用 RAG 模式回答問題\"\"\"\n",
        "    session = get_user_session(user_id)\n",
        "    uploaded_file = session[\"uploaded_file\"]\n",
        "\n",
        "    if uploaded_file:\n",
        "        # 有上傳檔案，使用 RAG 模式\n",
        "        response = client.models.generate_content(\n",
        "            model=\"gemini-2.5-flash\",\n",
        "            contents=[\n",
        "                types.Content(\n",
        "                    role=\"user\",\n",
        "                    parts=[\n",
        "                        types.Part.from_uri(\n",
        "                            file_uri=uploaded_file.uri,\n",
        "                            mime_type=uploaded_file.mime_type\n",
        "                        ),\n",
        "                        types.Part.from_text(text=f\"請根據上述提供的檔案內容，用繁體中文回答這個問題：{question}\")\n",
        "                    ]\n",
        "                )\n",
        "            ]\n",
        "        )\n",
        "        return response.text\n",
        "    else:\n",
        "        # 沒有上傳檔案，使用一般多輪對話\n",
        "        response = session[\"chat\"].send_message(message=question)\n",
        "        return response.text\n",
        "\n",
        "@app.route(\"/\", methods=['POST'])\n",
        "def callback():\n",
        "    signature = request.headers['X-Line-Signature']\n",
        "    body = request.get_data(as_text=True)\n",
        "    print(\"BODY: \", body)\n",
        "    app.logger.info(\"Request body: \" + body)\n",
        "\n",
        "    try:\n",
        "        handler.handle(body, signature)\n",
        "    except InvalidSignatureError:\n",
        "        app.logger.info(\"Invalid signature.\")\n",
        "        abort(400)\n",
        "\n",
        "    return 'OK'\n",
        "\n",
        "@handler.add(MessageEvent, message=TextMessageContent)\n",
        "def handle_message(event):\n",
        "    \"\"\"處理文字訊息\"\"\"\n",
        "    text = event.message.text\n",
        "    user_id = event.source.user_id\n",
        "\n",
        "    with ApiClient(configuration) as api_client:\n",
        "        line_bot_api = MessagingApi(api_client)\n",
        "\n",
        "        if text.startswith('AI '):\n",
        "            prompt = text[3:]\n",
        "            try:\n",
        "                # 使用 RAG 或一般對話\n",
        "                reply_text = query_with_rag(user_id, prompt)\n",
        "\n",
        "                # 檢查是否有上傳檔案，加上提示\n",
        "                session = get_user_session(user_id)\n",
        "                if session[\"uploaded_file\"]:\n",
        "                    reply_text = f\"📄 [RAG 模式]\\n\\n{reply_text}\"\n",
        "\n",
        "                line_bot_api.reply_message_with_http_info(\n",
        "                    ReplyMessageRequest(\n",
        "                        reply_token=event.reply_token,\n",
        "                        messages=[TextMessage(text=reply_text)]\n",
        "                    )\n",
        "                )\n",
        "            except Exception as e:\n",
        "                line_bot_api.reply_message_with_http_info(\n",
        "                    ReplyMessageRequest(\n",
        "                        reply_token=event.reply_token,\n",
        "                        messages=[TextMessage(text=f\"❌ 發生錯誤：{str(e)}\")]\n",
        "                    )\n",
        "                )\n",
        "        elif text == \"清除文件\":\n",
        "            # 清除使用者上傳的檔案\n",
        "            session = get_user_session(user_id)\n",
        "            session[\"uploaded_file\"] = None\n",
        "            line_bot_api.reply_message_with_http_info(\n",
        "                ReplyMessageRequest(\n",
        "                    reply_token=event.reply_token,\n",
        "                    messages=[TextMessage(text=\"✅ 已清除上傳的文件，恢復一般對話模式。\")]\n",
        "                )\n",
        "            )\n",
        "        else:\n",
        "            line_bot_api.reply_message_with_http_info(\n",
        "                ReplyMessageRequest(\n",
        "                    reply_token=event.reply_token,\n",
        "                    messages=[TextMessage(text=\"請輸入「AI 問題」來開始對話\\n或上傳 TXT/PDF 檔案啟用 RAG 模式\")]\n",
        "                )\n",
        "            )\n",
        "\n",
        "@handler.add(MessageEvent, message=FileMessageContent)\n",
        "def handle_file_message(event):\n",
        "    \"\"\"處理使用者上傳的檔案\"\"\"\n",
        "    user_id = event.source.user_id\n",
        "    file_name = event.message.file_name\n",
        "\n",
        "    with ApiClient(configuration) as api_client:\n",
        "        line_bot_api = MessagingApi(api_client)\n",
        "\n",
        "        # 檢查檔案類型\n",
        "        if not (file_name.endswith('.txt') or file_name.endswith('.pdf')):\n",
        "            line_bot_api.reply_message_with_http_info(\n",
        "                ReplyMessageRequest(\n",
        "                    reply_token=event.reply_token,\n",
        "                    messages=[TextMessage(text=\"⚠️ 目前只支援 TXT 或 PDF 檔案\")]\n",
        "                )\n",
        "            )\n",
        "            return\n",
        "\n",
        "        try:\n",
        "            # 下載檔案\n",
        "            file_path = download_line_file(event.message.id, file_name)\n",
        "            print(f\"檔案已下載：{file_path}\")\n",
        "\n",
        "            # 上傳到 Gemini\n",
        "            uploaded_file = upload_file_to_gemini(file_path)\n",
        "            print(f\"檔案已上傳到 Gemini：{uploaded_file.uri}\")\n",
        "\n",
        "            # 儲存到使用者 session\n",
        "            session = get_user_session(user_id)\n",
        "            session[\"uploaded_file\"] = uploaded_file\n",
        "\n",
        "            line_bot_api.reply_message_with_http_info(\n",
        "                ReplyMessageRequest(\n",
        "                    reply_token=event.reply_token,\n",
        "                    messages=[TextMessage(text=f\"✅ 檔案「{file_name}」上傳成功！\\n\\n現在您可以輸入「AI 問題」來詢問關於這份文件的問題。\\n\\n輸入「清除文件」可恢復一般對話模式。\")]\n",
        "                )\n",
        "            )\n",
        "        except Exception as e:\n",
        "            line_bot_api.reply_message_with_http_info(\n",
        "                ReplyMessageRequest(\n",
        "                    reply_token=event.reply_token,\n",
        "                    messages=[TextMessage(text=f\"❌ 檔案處理失敗：{str(e)}\")]\n",
        "                )\n",
        "            )\n",
        "\n",
        "if __name__ == \"__main__\":\n",
        "    app.run(port=port)"
      ]
    }
  ],
  "metadata": {
    "colab": {
      "provenance": []
    },
    "kernelspec": {
      "display_name": "linebot",
      "language": "python",
      "name": "python3"
    },
    "language_info": {
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "file_extension": ".py",
      "mimetype": "text/x-python",
      "name": "python",
      "nbconvert_exporter": "python",
      "pygments_lexer": "ipython3",
      "version": "3.12.3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 0
}
